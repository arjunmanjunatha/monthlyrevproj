<html>

  <head>
    <title>Report 22</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.0.0-rc.7/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0 auto;
        max-width: 800px;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #333;
      }

      .btn {
        display: block;
        width: 200px;
        height: 40px;
        margin: 20px auto;
        background: #3498db;
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        outline: none;
        transition: background-color 0.3s ease;
      }

      .btn:hover {
        background-color: #2980b9;
      }

      .btn:active {
        background-color: #3498db;
        box-shadow: 0 5px #2980b9;
        transform: translateY(4px);
      }

      #csvFile {
        display: none;
      }

      #uploadLabel {
        display: inline-block;
        margin: 0 auto 20px;
      }

      #statusMessage {
        color: #2ecc71;
        /* Default to the "success" color */
        text-align: center;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      #resultsWindow {
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        margin-top: 20px;
      }

    </style>
  </head>

  <body>
    <h1>Report 22</h1>

    <label id="uploadLabel" for="csvFile" class="btn">Upload CSV</label>
    <input type="file" id="csvFile" accept=".csv">

    <p id="statusMessage"></p>

    <button id="generateReport" class="btn">Generate Report</button>

    <div id="resultsWindow">
      <table id="reportTable">
        <thead>
          <tr>
            <th>Month, Year</th>
            <th>Commission</th>
          </tr>
        </thead>
        <tbody>
          <!-- tbody is left empty as rows will be appended dynamically -->
        </tbody>
      </table>
    </div>


    <button id="saveAsImage" class="btn">Copy Table to Clipboard</button>


    <script>
document.addEventListener('DOMContentLoaded', function() {
    var data = [];
    document.getElementById('csvFile').addEventListener('change', function(e) {
        var file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            complete: function (results) {
                var expectedHeaders = [
                    'Provider', 'Category', 'Booked Date', 'Start Date', 'End Date', 
                    'Booking Status', 'Commission', 'Device', 'Campaign IDs', 'Nights', 
                    'Info', 'Destination', 'Booking Id', 'User Country', 'Payment Status'
                ];
                if(JSON.stringify(results.meta.fields) === JSON.stringify(expectedHeaders)) {
                    data = results.data;
                    document.getElementById('statusMessage').style.color = '#2ecc71';
                    document.getElementById('statusMessage').innerText = 'Ready to generate, boss!';
                } else {
                    document.getElementById('statusMessage').style.color = '#e74c3c';
                    document.getElementById('statusMessage').innerText = 'You trippin, bro?';
                }
            }
        });
    });

    document.getElementById('generateReport').addEventListener('click', function() {
        var commissions = [];

        data.forEach(function (record) {
            if(record['Booking Status'] !== 'Canceled') {
                var endDate = record['End Date'] ? new Date(record['End Date']) : null;
                var bookedDate = new Date(record['Booked Date']);
                var payoutDate;

                if(endDate) {
                    payoutDate = new Date(endDate);
                    payoutDate.setDate(payoutDate.getDate() + 7);
                } else {
                    payoutDate = new Date(bookedDate);
                    payoutDate.setDate(payoutDate.getDate() + 90);
                }

                var monthYear = `${payoutDate.getMonth() + 1}/01/${payoutDate.getFullYear()}`;
                var existing = commissions.find(com => com.date === monthYear);

                if(existing) {
                    existing.commission += parseFloat(record['Commission']);
                } else {
                    commissions.push({ date: monthYear, commission: parseFloat(record['Commission']) });
                }
            }
        });

        // Sort the commissions array chronologically
        commissions.sort((a, b) => new Date(a.date) - new Date(b.date));

        var tableBody = document.querySelector('#reportTable tbody');
        tableBody.innerHTML = ''; // clear the table body

        commissions.forEach(function(commission) {
            var row = document.createElement('tr');
            var monthYearCell = document.createElement('td');
            monthYearCell.textContent = new Date(commission.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            var commissionCell = document.createElement('td');
            commissionCell.textContent = commission.commission.toFixed(2);

            row.appendChild(monthYearCell);
            row.appendChild(commissionCell);
            tableBody.appendChild(row);
        });
    });
});
</script>

  </body>

</html>
